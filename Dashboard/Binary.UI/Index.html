<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>DashboardDemo</title>

    
	<script src="Scripts/ext-all-debug-w-comments.js"></script>    
	<script src="Scripts/ext-theme-neptune.js"></script>
	<link href="Scripts/ext-theme-neptune-all.css" rel="stylesheet" />
	<script src="Scripts/jquery-1.9.1.js"></script>

	<script src="Scripts/Portlet.js"></script>
	<script src="Scripts/PortalColumn.js"></script>
	<script src="Scripts/PortalDropZone.js"></script>
	<script src="Scripts/PortalPanel.js"></script>

	<script src="Scripts/Dashboard.js"></script>
    <script src="Scripts/Panel.js"></script>
	<script src="Scripts/Mediator.js"></script>
	<script src="Scripts/LayoutFactory.js"></script>
	<script src="Scripts/LeftPanelDashboardEditor.js"></script>

	<script src="../Scripts/Binary/Binary.Core.js"></script>
	<script src="../Scripts/Binary/Binary.Api.Manager.js"></script>
	
	<link href="Scripts/cs.css" rel="stylesheet" />
	<style>
	 html, body
	 {
		 height:100%;
	 }
	</style>
</head>
<body>
    <div id="dashboardTest" class="dashboard-wrapper"></div>
	<script>
	    
		Ext.onReady(function ()
		{
			Ext.Loader.setConfig({ enabled: true });
			var proxyUrl = "http://localhost:57842";//"http://195.24.133.198";
			window.Dashboard = new Ext.app.Dashboard('dashboardTest', '1', 'local', 'dataComponents.json');

			var developerWidgetStore = Ext.create('Ext.data.Store',
			{
				type: 'localstorage',
				autoLoad: true,
				proxy:
				{
					type: 'localstorage',
					id: 'developerComponents'
				},
				fields: ['Name', 'ID', 'IconUrl', 'ComponentID', 'Options', 'DisplaySettings', 'Manifest', 'IsOwner']
			});

			var componentsUpdate = function ()
			{
				var components = window.Dashboard.getComponents();
				components.each(function (component)
				{
					if (component.data.Options.Url.indexOf("{proxyUrl}")>-1)
					{
						component.data.Options.Url = component.data.Options.Url.replace("{proxyUrl}", proxyUrl);
					}
				});
				developerWidgetStore.each(function (devComponent)
				{
					components.add(devComponent.data);
				});
			};
			Ext.app.Mediator.on("componentsLoaded", componentsUpdate);

			var leftPanel = Ext.app.Dashboard.ApplyLeftPanelDashboardEditor(window.Dashboard);
			var componentList = leftPanel.getComponentList();

			window.gadgetWindow = new Ext.window.Window(
			{
				width: 600,
				height: 400,
				title: 'Add new gadget',
				modal: true,
				processGadgetSubmit: function(e)
				{
					debugger;
					var result = $.parseJSON(e.originalEvent.data);
					if (!result.apiMethod)
					{
						$(window).unbind("message", window.gadgetWindow.processGadgetSubmit);
						if (result.validationResult)
						{
							var widget=
							{
								ID: result.ID,
								Manifest: result.manifest,
								Name: result.widget.ModulePrefs.Title,
								IconUrl: result.widget.ModulePrefs.ThumbnailUrl,
								IsOwner: true,
								Options:
								{
									Height: result.widget.ModulePrefs.Height || "300px",
									Collapsed: false,
									Title: result.widget.ModulePrefs.Title,
									IFrame: true,
									Url: result.widget.Content.Href,
									PreventExpandable: false,
									IconUrl: result.widget.ModulePrefs.ThumbnailUrl
								}
							};
							developerWidgetStore.add(widget);
							developerWidgetStore.sync();
							window.Dashboard.getComponents().add(widget);
							Ext.Msg.alert("Status", "Widget succesfully created");
						}
						else
						{
							Ext.Msg.show(
							{
								title: "Error",
								msg: result.messages.join('<br/>'),
								buttons: Ext.Msg.OK,
								icon: Ext.Msg.ERROR
							});
						}
					}
				},
				items:
				[
					{
						xtype: 'form',
						layout: 'fit',
						standardSubmit: true,
						url: proxyUrl + '/ValidateWidget',
						items:
						[
							{
								xtype: 'textarea',
								hideLabel: true,
								style: 'width:100%;',
								height: 350,
								name: 'widgetXml'
							}
						]
					},
					{
						xtype: 'container',
						width: 0,
						height: 0,
						html: '<iframe id="widgetSumbitFrame" name="widgetSumbitFrame"></iframe>'
					}
				],
				buttons:
				[
					{
						text: 'Validate & Add',
						handler: function()
						{
							$(window).bind("message", window.gadgetWindow.processGadgetSubmit);
							this.up().up().down('form').submit({ target: 'widgetSumbitFrame' });
						}
					},
					{
						text: 'Cancel',
						handler: function ()
						{
							window.gadgetWindow.close();
							window.gadgetWindow = null;
						}
					}
				]
			});
			window.gadgetWindow.show();
			componentList.add(
			{
				xtype: 'button',
				text: 'Add gadget',
				style:'margin:10px 0px 10px 10px;',
				listeners:
				{
					click: function ()
					{
					}
				}
			});

			Binary.Api.Manager = new window.Binary.Api.ManagerClass(proxyUrl);
			Binary.Api.Manager.BeginProcessing();
		});
	</script>
</body>
</html>
